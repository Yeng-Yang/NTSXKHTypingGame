<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∫ç‡∫≠‡∫î‡∫ß‡∫¥‡∫•‡∫∞‡∫ä‡∫ª‡∫ô‡∫ô‡ªâ‡∫≠‡∫ç‡∫û‡∫¥‡∫ä‡∫¥‡∫î‡∫Ñ‡∫≥‡∫™‡∫±‡∫ö ‡ªÅ‡∫•‡∫∞ ‡∫ï‡∫ª‡∫ß‡∫≠‡∫±‡∫Å‡∫™‡∫≠‡∫ô</title>
    <style>
        /* -------------------------- */
        /* CSS ‡∫™‡ªç‡∫≤‡∫•‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫≠‡∫≠‡∫Å‡ªÅ‡∫ö‡∫ö */
        /* -------------------------- */
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        #game-container {
            width: 800px;
            height: 500px;
            border: 5px solid #4CAF50;
            background-color: #000033;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        #player {
            position: absolute;
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 30px;
            color: #00796B;
            padding: 10px;
            background: #B2DFDB;
            border-radius: 5px;
            font-weight: bold;
            z-index: 5; 
        }

        .enemy {
            position: absolute;
            right: 0;
            width: auto;
            padding: 10px 15px;
            min-width: 60px;
            height: 40px;
            background-color: #FFCDD2;
            border: 2px solid #D32F2F;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            color: #D32F2F;
            transition: background-color 0.1s; 
            cursor: pointer;
            z-index: 2; 
            white-space: nowrap;
        }
        
        .highlight {
            color: #4CAF50; 
            font-weight: bold;
        }

        .bullet {
            position: absolute;
            width: 15px;
            height: 5px;
            background-color: #FFC107; 
            border-radius: 2px;
            z-index: 4; 
        }

        #stats {
            width: 800px;
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 10px 0;
            font-size: 18px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            padding: 0 15px;
            text-align: center;
        }

        .stat-item span {
            font-weight: bold;
            color: #388E3C;
        }

        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: bold;
            color: #F44336;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 10;
            display: none;
            text-align: center;
        }
        
        /* ‡ªú‡ªâ‡∫≤‡∫à‡ªç‡∫ï‡ªà‡∫≤‡∫á‡ªÜ (Start, Mode, Result) */
        #start-screen, #mode-screen, #result-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }
        #mode-screen, #result-screen {
             display: none; 
        }

        /* Result Screen Styles */
        #result-details {
            margin-top: 20px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            margin: 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.3);
        }
        .result-item span {
            font-weight: bold;
            color: #FFEB3B;
        }

        .lang-button {
            padding: 15px 30px;
            margin: 10px;
            font-size: 24px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }
        .mode-button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 18px;
            cursor: pointer;
            border: 1px solid white;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }

        #lao-btn { background-color: #FFEB3B; color: #333; }
        #en-btn { background-color: #2196F3; color: white; }

        /* Global Controls ‡ªÉ‡ªù‡ªà */
        #controls-global {
            width: 800px;
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        
        .control-button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 18px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        #restart-btn { background-color: #4CAF50; color: white; }
        #exit-btn { background-color: #F44336; color: white; }
        #back-to-menu-btn { background-color: #FF9800; color: white; }
        
        #progress-display {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 16px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
        }
    </style>
</head>
<body>

    <h1>‡∫ç‡∫≠‡∫î‡∫ß‡∫¥‡∫•‡∫∞‡∫ä‡∫ª‡∫ô‡∫ô‡ªâ‡∫≠‡∫ç‡∫û‡∫¥‡∫ä‡∫¥‡∫î‡∫Ñ‡∫≥‡∫™‡∫±‡∫ö ‡ªÅ‡∫•‡∫∞ ‡∫ï‡∫ª‡∫ß‡∫≠‡∫±‡∫Å‡∫™‡∫≠‡∫ô</h1>

    <div id="game-container">
        <div id="player">üöÄ</div>

        <div id="start-screen">
            <h2>‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫û‡∫≤‡∫™‡∫≤ / Choose Language</h2>
            <div class="mode-section">
                <button id="lao-btn" class="lang-button" data-lang="lao">‡∫û‡∫≤‡∫™‡∫≤‡∫•‡∫≤‡∫ß</button>
                <button id="en-btn" class="lang-button" data-lang="en">English</button>
            </div>
            <p style="margin-top: 20px;">**‡∫ï‡ªâ‡∫≠‡∫á‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫û‡∫≤‡∫™‡∫≤‡∫Å‡ªà‡∫≠‡∫ô‡∫à‡∫∂‡ªà‡∫á‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÇ‡ªù‡∫î‡ªÑ‡∫î‡ªâ**</p>
        </div>
        
        <div id="mode-screen">
            <h2>‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÇ‡ªù‡∫î‡ªÄ‡∫Å‡∫°</h2>
            <div class="mode-section">
                <button id="char-mode-btn" class="mode-button" data-mode="char">‡ªÇ‡ªù‡∫î‡∫û‡∫¥‡∫°‡∫ï‡∫ª‡∫ß‡∫≠‡∫±‡∫Å‡∫™‡∫≠‡∫ô</button>
                <button id="word-mode-btn" class="mode-button" data-mode="word">‡ªÇ‡ªù‡∫î‡∫û‡∫¥‡∫°‡∫Ñ‡∫≥‡∫™‡∫±‡∫ö</button>
            </div>
        </div>

        <div id="result-screen">
            <h2 id="result-message">GAME OVER / ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß</h2>
            <div id="result-details">
                <div class="result-item">‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫•‡∫ß‡∫°: <span id="final-score">0</span></div>
                <div class="result-item">Level ‡∫™‡∫∏‡∫î‡∫ó‡ªâ‡∫≤‡∫ç: <span id="final-level">1</span></div>
                <div class="result-item">‡∫û‡∫¥‡∫°‡∫ñ‡∫∑‡∫Å: <span id="final-correct">0</span></div>
                <div class="result-item">‡∫û‡∫¥‡∫°‡∫ú‡∫¥‡∫î: <span id="final-incorrect">0</span></div>
                <div class="result-item">‡∫Ñ‡∫ß‡∫≤‡∫°‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á: <span id="final-accuracy">0%</span></div>
            </div>
        </div>

        <div id="message"></div>
        <div id="progress-display"></div>

    </div>

    <div id="stats">
        <div class="stat-item">Level: <span id="level-display">1</span></div>
        <div class="stat-item">‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô: <span id="score-display">0</span></div>
        <div class="stat-item" style="color: #D32F2F;">‡∫ñ‡∫∑‡∫Å‡ªÇ‡∫à‡∫°‡∫ï‡∫µ: <span id="damage-display">0</span> / 15</div>
        <div class="stat-item" style="color: #388E3C;">‡∫û‡∫¥‡∫°‡∫ñ‡∫∑‡∫Å: <span id="correct-display">0</span></div>
        <div class="stat-item" style="color: #FBC02D;">‡∫û‡∫¥‡∫°‡∫ú‡∫¥‡∫î: <span id="incorrect-display">0</span></div>
    </div>
    
    <div id="controls-global">
        <button id="back-to-menu-btn" class="control-button">üè† ‡ªú‡ªâ‡∫≤‡∫´‡∫º‡∫±‡∫Å</button>
        <button id="restart-btn" class="control-button" style="display: none;">üîÑ ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÉ‡ªù‡ªà</button>
    </div>

    <script>
        /* -------------------------- */
        /* JavaScript ‡∫™‡ªç‡∫≤‡∫•‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡ªÄ‡∫Å‡∫° */
        /* -------------------------- */

        // ‡ªÇ‡∫Ñ‡∫á‡∫™‡ªâ‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô Level
        const charLevels = {
            1: { lao: ['‡∫Å', '‡∫Ç', '‡∫Ñ', '‡∫á', '‡∫à', '‡∫ä', '‡∫ç', '‡∫î', '‡∫ï', '‡∫ñ', '‡∫ó', '‡∫ô', '‡∫ö', '‡∫õ', '‡∫ú', '‡∫ù', '‡∫û', '‡∫ü', '‡∫°', '‡∫¢', '‡∫£', '‡∫•', '‡∫ß', '‡∫™', '‡∫´'], en: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'], speed: 1.0 },
            // ... (Levels ‡∫≠‡∫∑‡ªà‡∫ô‡ªÜ)
        };
        const wordLevels = {
            1: { 
                lao: ['‡∫™‡∫∞‡∫ö‡∫≤‡∫ç‡∫î‡∫µ', '‡ªÇ‡∫Æ‡∫á‡∫Æ‡∫Ω‡∫ô', '‡∫Ñ‡∫≠‡∫°‡∫û‡∫¥‡∫ß‡ªÄ‡∫ï‡∫µ', '‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö', '‡∫≠‡∫¥‡∫ô‡ªÄ‡∫ï‡∫µ‡ªÄ‡∫ô‡∫±‡∫î', '‡ªÄ‡∫Å‡∫°', '‡∫•‡∫∞‡∫´‡∫±‡∫î', '‡∫û‡∫≤‡∫™‡∫≤', '‡ªÇ‡∫•‡∫Å', '‡∫î‡∫≤‡∫ß', 
                      '‡∫ï‡∫ª‡∫ß‡∫¢‡ªà‡∫≤‡∫á', '‡∫Å‡∫≤‡∫ô‡∫û‡∫¥‡∫°', '‡∫û‡∫±‡∫î‡∫ó‡∫∞‡∫ô‡∫≤', '‡ªú‡ªâ‡∫≤‡∫à‡ªç', '‡∫Ñ‡∫ß‡∫≤‡∫°‡ªÑ‡∫ß', '‡∫™‡∫∂‡∫Å‡∫™‡∫≤', '‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô', '‡∫Å‡∫≤‡∫ô‡∫™‡ªâ‡∫≤‡∫á', '‡∫ß‡∫¥‡ªÑ‡∫™‡∫ó‡∫±‡∫î', '‡∫õ‡∫∞‡∫™‡∫¥‡∫î‡∫ó‡∫¥‡∫û‡∫≤‡∫ö'], 
                en: ['hello', 'world', 'computer', 'keyboard', 'programming', 'language', 'javascript', 'html', 'coding', 'space',
                     'typing', 'game', 'level', 'mode', 'difficulty', 'software', 'network', 'system', 'project', 'server'], 
                speed: 1.0 
            },
             // ... (Levels ‡∫≠‡∫∑‡ªà‡∫ô‡ªÜ)
        };

        // ‡∫ï‡∫ª‡∫ß‡∫õ‡ªà‡∫Ω‡∫ô‡ªÄ‡∫Å‡∫°
        let currentLanguage = '';
        let currentMode = ''; 
        let currentLevelsData = charLevels; 
        let currentLevel = 1;
        let score = 0;
        let damage = 0;
        let correctHits = 0;
        let incorrectHits = 0;
        const maxDamage = 15;
        let isGameOver = false;
        let currentEnemy = null; 
        let wordsRemaining = []; 
        let allWordsInLevel = []; 
        let targetWord = ''; 
        let typedPrefix = ''; 

        // DOM Elements
        const gameContainer = document.getElementById('game-container');
        const messageDisplay = document.getElementById('message');
        const progressDisplay = document.getElementById('progress-display');
        const startScreen = document.getElementById('start-screen');
        const modeScreen = document.getElementById('mode-screen');
        const resultScreen = document.getElementById('result-screen');
        const globalControls = document.getElementById('controls-global');
        const restartBtn = document.getElementById('restart-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');

        // Stats Display
        const damageDisplay = document.getElementById('damage-display');
        const scoreDisplay = document.getElementById('score-display');
        const correctDisplay = document.getElementById('correct-display');
        const incorrectDisplay = document.getElementById('incorrect-display');
        const levelDisplay = document.getElementById('level-display');
        
        // Audio (‡∫ç‡∫±‡∫á‡∫Ñ‡∫ª‡∫á‡ªÄ‡∫î‡∫µ‡∫°)
        const audio = {
            shoot: new Audio('shoot_sound.wav'), explosion: new Audio('explosion_sound.wav'), error: new Audio('error_sound.wav'),    
            gameOver: new Audio('gameover_sound.wav'), levelUp: new Audio('level_up_sound.wav'), damage: new Audio('damage_sound.wav') 
        };
        function playAudio(type) {
             if (audio[type]) { audio[type].currentTime = 0; audio[type].play().catch(e => console.log("Audio play blocked:", e)); }
        }

        // ------------------------------------
        // ‡∫ü‡∫±‡∫á‡∫ä‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫™‡∫∞‡ªÅ‡∫î‡∫á‡ªú‡ªâ‡∫≤‡∫à‡ªç (UI FLOW CONTROL)
        // ------------------------------------

        function setScreen(screenId) {
            startScreen.style.display = 'none';
            modeScreen.style.display = 'none';
            resultScreen.style.display = 'none';
            gameContainer.style.background = '#000033'; // ‡∫û‡∫∑‡ªâ‡∫ô‡∫´‡∫º‡∫±‡∫á‡ªÄ‡∫Å‡∫°
            
            // ‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫á‡∫õ‡∫∏‡ªà‡∫° restart ‡ªÄ‡∫ß‡∫±‡ªâ‡∫ô‡ªÄ‡∫™‡∫ç‡ªÅ‡∫ï‡ªà‡∫¢‡∫π‡ªà‡ªÉ‡∫ô Mode/Result
            restartBtn.style.display = 'none'; 
            backToMenuBtn.style.display = 'inline-block';

            if (screenId === 'start') {
                startScreen.style.display = 'flex';
                // ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫õ‡∫∏‡ªà‡∫° restart ‡ªÉ‡∫ô‡ªú‡ªâ‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫û‡∫≤‡∫™‡∫≤
            } else if (screenId === 'mode') {
                modeScreen.style.display = 'flex';
                // ‡ªÉ‡∫´‡ªâ‡ªÄ‡∫´‡∫±‡∫ô‡∫õ‡∫∏‡ªà‡∫° restart (‡∫Å‡∫±‡∫ö‡∫Ñ‡∫∑‡∫ô‡ªÑ‡∫õ start-screen)
                restartBtn.style.display = 'inline-block';
                restartBtn.textContent = 'üè† ‡∫Å‡∫±‡∫ö‡∫Ñ‡∫∑‡∫ô'; 
            } else if (screenId === 'result') {
                resultScreen.style.display = 'flex';
                restartBtn.style.display = 'inline-block';
                restartBtn.textContent = 'üîÑ ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÉ‡ªù‡ªà'; 
            } else if (screenId === 'game') {
                // ‡ªÄ‡∫°‡∫∑‡ªà‡∫≠‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡ªÄ‡∫Å‡∫°, ‡ªÉ‡∫´‡ªâ‡∫õ‡∫∏‡ªà‡∫° restart ‡ªÄ‡∫Æ‡∫±‡∫î‡∫ß‡∫Ω‡∫Å‡ªÄ‡∫õ‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÉ‡ªù‡ªà
                restartBtn.style.display = 'inline-block';
                restartBtn.textContent = 'üîÑ ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÉ‡ªù‡ªà'; 
            }
        }
        
        function backToMenu() {
            isGameOver = true;
            // ‡ªÄ‡∫Ñ‡∫ç‡∫™‡∫±‡∫î‡∫ï‡∫π‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î
            document.querySelectorAll('.enemy').forEach(e => clearInterval(parseInt(e.getAttribute('data-interval'))));
            document.querySelectorAll('.enemy').forEach(e => e.remove()); 
            document.querySelectorAll('.bullet').forEach(b => b.remove()); 

            currentLanguage = ''; 
            currentMode = '';
            currentEnemy = null; 
            messageDisplay.style.display = 'none';

            setScreen('start'); 
        }

        function showModeScreen() {
             // ‡ªÉ‡∫ä‡ªâ‡∫Ñ‡∫∑‡∫ô‡∫õ‡∫∏‡ªà‡∫° restart ‡ªÄ‡∫õ‡∫±‡∫ô‡∫õ‡∫∏‡ªà‡∫° "‡∫Å‡∫±‡∫ö‡∫Ñ‡∫∑‡∫ô"
            restartBtn.removeEventListener('click', restartGame); 
            restartBtn.addEventListener('click', backToMenu); 
            
            setScreen('mode');
        }

        function showResultScreen(message, isSuccess) {
            setScreen('result');
            
            // ‡∫ú‡∫π‡∫Å‡∫õ‡∫∏‡ªà‡∫° Restart ‡ªÉ‡ªù‡ªà
            restartBtn.removeEventListener('click', backToMenu); 
            restartBtn.addEventListener('click', restartGame); 

            // ‡∫™‡∫∞‡ªÅ‡∫î‡∫á‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫° ‡ªÅ‡∫•‡∫∞ ‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î
            document.getElementById('result-message').textContent = message;
            document.getElementById('result-message').style.color = isSuccess ? '#4CAF50' : '#F44336';
            
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-level').textContent = currentLevel;
            document.getElementById('final-correct').textContent = correctHits;
            document.getElementById('final-incorrect').textContent = incorrectHits;

            const totalTyped = correctHits + incorrectHits;
            const accuracy = totalTyped > 0 
                ? ((correctHits / totalTyped) * 100).toFixed(2)
                : 0;
            
            document.getElementById('final-accuracy').textContent = `${accuracy}%`;
        }

        // ------------------------------------
        // ‡∫ü‡∫±‡∫á‡∫ä‡∫±‡∫ô‡ªÄ‡∫Å‡∫°‡∫´‡∫º‡∫±‡∫Å (Game Logic)
        // ------------------------------------

        function updateStats() {
            // ... (‡∫ç‡∫±‡∫á‡∫Ñ‡∫ª‡∫á‡ªÄ‡∫î‡∫µ‡∫°)
            damageDisplay.textContent = damage;
            scoreDisplay.textContent = score;
            correctDisplay.textContent = correctHits;
            incorrectDisplay.textContent = incorrectHits;
            levelDisplay.textContent = currentLevel;
            
            const totalItems = allWordsInLevel.length;
            const remainingItems = wordsRemaining.length;
            const completedItems = totalItems - remainingItems;
            const progressUnit = currentMode === 'char' 
                ? (currentLanguage === 'lao' ? '‡∫ï‡∫ª‡∫ß‡∫≠‡∫±‡∫Å‡∫™‡∫≠‡∫ô' : 'Characters') 
                : (currentLanguage === 'lao' ? '‡∫Ñ‡∫≥‡∫™‡∫±‡∫ö' : 'Words');

            progressDisplay.textContent = `Progress: ${completedItems} / ${totalItems} ${progressUnit}`;
        }
        
        // ... (renderEnemyText, moveEnemy, createBullet, hitItem, enemyAttack, takeDamage ‡∫ç‡∫±‡∫á‡∫Ñ‡∫ª‡∫á‡ªÄ‡∫î‡∫µ‡∫°) ...
        
        // ‡∫ï‡ªâ‡∫≠‡∫á‡ªÄ‡∫û‡∫µ‡ªà‡∫° Logic ‡∫ó‡∫µ‡ªà‡∫Ç‡∫≤‡∫î‡ªÑ‡∫õ‡∫Ñ‡∫∑‡∫ô
        function renderEnemyText(enemy, fullText, prefix) {
            if (currentMode === 'char') { enemy.textContent = fullText; } 
            else {
                const remaining = fullText.substring(prefix.length);
                const content = `<span class="highlight">${prefix}</span>${remaining}`;
                enemy.innerHTML = content;
            }
        }
        
        function moveEnemy(enemy) {
            const speed = currentLevelsData[currentLevel].speed;
            const moveInterval = 20; 
            const speedMultiplier = speed * 1.5; 
            const isCharMode = currentMode === 'char';
            const playerCollisionX = document.getElementById('player').offsetWidth + document.getElementById('player').offsetLeft + (isCharMode ? 0 : 10); 

            const interval = setInterval(() => {
                if (isGameOver || !enemy.parentElement) {
                    clearInterval(interval);
                    return;
                }

                let currentRight = parseFloat(enemy.style.right) || 0;
                let newRight = currentRight + speedMultiplier; 
                let currentX = gameContainer.offsetWidth - newRight; 

                if (currentX <= playerCollisionX) { 
                    clearInterval(interval);
                    enemyAttack(enemy, true); 
                    if (currentEnemy === enemy) { currentEnemy = null; targetWord = ''; typedPrefix = ''; }
                    enemy.remove();
                    spawnNextEnemy(); 
                    return;
                }

                enemy.style.right = `${newRight}px`;
                enemy.setAttribute('data-pos-x', currentX - (isCharMode ? 30 : 75)); 
                
            }, moveInterval);

            enemy.setAttribute('data-interval', interval);
        }
        
        function createBullet(targetEnemy) {
            if (!targetEnemy || !targetEnemy.parentElement) return; 
            playAudio('shoot');

            const playerX = document.getElementById('player').offsetLeft + document.getElementById('player').offsetWidth;
            const playerY = document.getElementById('player').offsetTop + (document.getElementById('player').offsetHeight / 2) - 2.5;
            
            const bullet = document.createElement('div');
            bullet.classList.add('bullet');
            bullet.style.top = `${playerY}px`;
            bullet.style.left = `${playerX}px`;
            gameContainer.appendChild(bullet);

            const BULLET_SPEED = 25; 
            const moveInterval = 10; 
            const isWordHit = currentMode === 'word';

            const bulletInterval = setInterval(() => {
                if (isGameOver || !targetEnemy.parentElement) {
                    clearInterval(bulletInterval);
                    bullet.remove();
                    return;
                }

                const targetX = parseFloat(targetEnemy.getAttribute('data-pos-x'));
                const targetY = parseFloat(targetEnemy.getAttribute('data-pos-y'));
                
                let currentX = parseFloat(bullet.style.left);
                let currentY = parseFloat(bullet.style.top);
                
                const deltaX = targetX - currentX;
                const deltaY = targetY - currentY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

                if (distance < BULLET_SPEED) {
                    clearInterval(bulletInterval);
                    bullet.remove();
                    hitItem(targetEnemy, isWordHit);
                    return;
                }
                
                const ratio = BULLET_SPEED / distance;
                const moveX = deltaX * ratio;
                const moveY = deltaY * ratio;
                
                bullet.style.left = `${currentX + moveX}px`;
                bullet.style.top = `${currentY + moveY}px`;

            }, moveInterval);
        }

        function hitItem(enemy, isWordHit) {
            if (!enemy || !enemy.parentElement) return; 
            const itemHit = enemy.getAttribute('data-word');

            const index = wordsRemaining.indexOf(itemHit);
            if (index > -1) { wordsRemaining.splice(index, 1); }

            playAudio('explosion'); 
            clearInterval(parseInt(enemy.getAttribute('data-interval')));
            
            enemy.style.backgroundColor = '#8BC34A'; 
            enemy.innerHTML = 'üí•'; 
            score += isWordHit ? 10 * itemHit.length : 10; 
            correctHits++;
            
            if (currentEnemy === enemy) { currentEnemy = null; targetWord = ''; typedPrefix = ''; }
            
            setTimeout(() => {
                enemy.remove();
                spawnNextEnemy(); 
            }, 100);
        }

        function enemyAttack(aggressor, isOverrun = false) {
             if (isGameOver) return;
             takeDamage(aggressor, isOverrun); 

             if (!isOverrun && aggressor) {
                aggressor.style.backgroundColor = '#FF5252';
                setTimeout(() => { aggressor.style.backgroundColor = '#FFCDD2'; }, 200);
             }
        }

        function takeDamage(aggressor, isOverrun) {
            if (isGameOver) return;
            
            playAudio('damage'); 
            damage++;
            damageDisplay.style.color = '#F44336';
            setTimeout(() => { damageDisplay.style.color = '#D32F2F'; }, 100);
            updateStats();

            if (damage >= maxDamage) {
                endGame(currentLanguage === 'lao' ? '‡ªÄ‡∫Å‡∫°‡∫à‡∫ª‡∫ö! ‡∫ó‡ªà‡∫≤‡∫ô‡∫ñ‡∫∑‡∫Å‡ªÇ‡∫à‡∫°‡∫ï‡∫µ 15 ‡∫Ñ‡∫±‡ªâ‡∫á' : 'GAME OVER! You took 15 hits', false);
            }
        }
        
        function checkLevelComplete() {
            const maxLevel = Object.keys(currentLevelsData).length; 

            if (wordsRemaining.length === 0) {
                if (currentLevel < maxLevel) {
                    playAudio('levelUp'); 
                    currentLevel++;
                    
                    const dataSet = currentLevelsData[currentLevel][currentLanguage];
                    allWordsInLevel = [...dataSet]; 
                    wordsRemaining = [...dataSet]; 

                    const nextLevelMsg = currentLanguage === 'lao' 
                        ? `‡∫ú‡ªà‡∫≤‡∫ô Level ${currentLevel - 1} ‡ªÅ‡∫•‡ªâ‡∫ß! ‡ªÑ‡∫õ Level ${currentLevel}` 
                        : `Level ${currentLevel - 1} Complete! Next Level: ${currentLevel}`;
                    
                    messageDisplay.textContent = nextLevelMsg;
                    messageDisplay.style.display = 'block';
                    
                    setTimeout(() => {
                        messageDisplay.style.display = 'none';
                        spawnNextEnemy(); 
                        updateStats();
                    }, 3000);
                } else {
                    endGame(currentLanguage === 'lao' ? '‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î! ‡∫ó‡ªà‡∫≤‡∫ô‡∫Ñ‡∫∑‡∫ç‡∫≠‡∫î‡∫ß‡∫¥‡∫•‡∫∞‡∫ä‡∫ª‡∫ô‡ªÇ‡∫ï‡∫à‡∫¥‡∫á!' : 'CONGRATULATIONS! You are a true Letter Hero!', true);
                }
            }
        }
        
        function spawnNextEnemy() {
            if (isGameOver) return;
            if (currentEnemy && currentEnemy.parentElement) return; 
            
            if (wordsRemaining.length === 0) {
                checkLevelComplete();
                return;
            }

            targetWord = wordsRemaining[Math.floor(Math.random() * wordsRemaining.length)];
            typedPrefix = ''; 
            
            // ‡∫õ‡∫±‡∫ö‡∫Ç‡∫∞‡ªú‡∫≤‡∫î‡∫™‡∫±‡∫î‡∫ï‡∫π‡∫ï‡∫≤‡∫° Mode
            const isCharMode = currentMode === 'char';
            const size = isCharMode ? 60 : 'auto'; 
            const minWidth = isCharMode ? '60px' : 'auto';
            const height = isCharMode ? '60px' : '40px';
            const fontSize = isCharMode ? 35 : 20; 
            const padding = isCharMode ? '10px' : '10px 15px';
            const borderRadius = isCharMode ? '50%' : '5px';
            const enemyOffset = isCharMode ? 30 : 75; 
            const startRight = isCharMode ? `-60px` : `-150px`;

            const randomY = Math.max(30, Math.min(470, Math.random() * (gameContainer.clientHeight - (isCharMode ? 60 : 40)))); 

            const enemy = document.createElement('div');
            enemy.classList.add('enemy');
            
            enemy.style.width = size;
            enemy.style.minWidth = minWidth;
            enemy.style.height = height;
            enemy.style.borderRadius = borderRadius;
            enemy.style.fontSize = `${fontSize}px`;
            enemy.style.padding = padding;
            
            renderEnemyText(enemy, targetWord, typedPrefix); 
            
            enemy.setAttribute('data-word', targetWord);
            enemy.style.top = `${randomY}px`;
            enemy.style.right = startRight;
            
            enemy.setAttribute('data-pos-x', gameContainer.offsetWidth - enemyOffset); 
            enemy.setAttribute('data-pos-y', randomY + (isCharMode ? 30 : 20)); 

            gameContainer.appendChild(enemy);
            currentEnemy = enemy; 

            moveEnemy(enemy);
        }

        // ------------------------------------
        // END GAME LOGIC (‡∫õ‡∫±‡∫ö‡∫õ‡∫∏‡∫á)
        // ------------------------------------

        function endGame(msg, isSuccess) {
            playAudio('gameOver'); 
            isGameOver = true;
            document.querySelectorAll('.enemy').forEach(e => clearInterval(parseInt(e.getAttribute('data-interval'))));
            
            // ‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫á‡∫™‡∫±‡∫î‡∫ï‡∫π‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î
            document.querySelectorAll('.enemy').forEach(e => e.remove()); 
            
            showResultScreen(msg, isSuccess);
        }

        function initializeGame(lang, mode) {
            // ‡∫õ‡∫¥‡∫î‡∫™‡∫Ω‡∫á‡ªÄ‡∫°‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÄ‡∫Å‡∫°‡ªÉ‡ªù‡ªà‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫´‡∫º‡∫µ‡∫Å‡∫•‡ªâ‡∫Ω‡∫á‡∫Å‡∫≤‡∫ô‡∫ï‡∫¥‡∫î‡∫Ç‡∫±‡∫î
            Object.values(audio).forEach(sound => {
                sound.muted = true;
                sound.play().catch(e => {});
                sound.muted = false;
                sound.pause();
                sound.currentTime = 0;
            });
            
            currentLanguage = lang;
            currentMode = mode;
            currentLevelsData = (mode === 'word' ? wordLevels : charLevels);
            
            // Reset Stats
            currentLevel = 1; score = 0; damage = 0; correctHits = 0; incorrectHits = 0;
            isGameOver = false; currentEnemy = null; typedPrefix = ''; targetWord = '';

            const dataSet = currentLevelsData[currentLevel][currentLanguage];
            allWordsInLevel = [...dataSet]; 
            wordsRemaining = [...dataSet]; 

            // ‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡ªú‡ªâ‡∫≤‡∫à‡ªç‡ªÄ‡∫Å‡∫°
            setScreen('game');
            document.querySelectorAll('.enemy').forEach(e => e.remove()); 
            document.querySelectorAll('.bullet').forEach(b => b.remove()); 
            messageDisplay.style.display = 'none';

            updateStats();
            spawnNextEnemy(); 
        }

        function restartGame() {
            if (currentLanguage && currentMode) {
                 initializeGame(currentLanguage, currentMode);
            } else {
                 backToMenu(); // ‡∫ñ‡ªâ‡∫≤‡∫ö‡ªç‡ªà‡∫°‡∫µ Mode ‡ªÉ‡∫´‡ªâ‡∫Å‡∫±‡∫ö‡ªÑ‡∫õ‡ªú‡ªâ‡∫≤‡∫´‡∫º‡∫±‡∫Å
            }
        }

        // ------------------------------------
        // Event Listeners
        // ------------------------------------

        // ‡∫Ç‡∫±‡ªâ‡∫ô‡∫ï‡∫≠‡∫ô‡∫ó‡∫µ 1: ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫û‡∫≤‡∫™‡∫≤
        document.querySelectorAll('.lang-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                currentLanguage = e.target.getAttribute('data-lang'); 
                document.querySelectorAll('.lang-button').forEach(b => b.style.border = 'none');
                e.target.style.border = '3px solid white';
                showModeScreen();
            });
        });
        
        // ‡∫Ç‡∫±‡ªâ‡∫ô‡∫ï‡∫≠‡∫ô‡∫ó‡∫µ 2: ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÇ‡ªù‡∫î
        document.querySelectorAll('.mode-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const mode = e.target.getAttribute('data-mode');
                initializeGame(currentLanguage, mode);
            });
        });
        
        // ‡∫õ‡∫∏‡ªà‡∫°‡∫Ñ‡∫ß‡∫ö‡∫Ñ‡∫∏‡∫° Global
        backToMenuBtn.addEventListener('click', backToMenu);
        restartBtn.addEventListener('click', restartGame); // ‡∫õ‡∫∏‡ªà‡∫°‡∫ô‡∫µ‡ªâ‡∫à‡∫∞‡∫õ‡ªà‡∫Ω‡∫ô‡ªú‡ªâ‡∫≤‡∫ó‡∫µ‡ªà‡∫ï‡∫≤‡∫°‡ªú‡ªâ‡∫≤‡∫à‡ªç‡∫ó‡∫µ‡ªà‡∫¢‡∫π‡ªà

        // ‡∫õ‡∫∏‡ªà‡∫°‡∫Å‡∫ª‡∫î (Keydown) - Logic ‡∫ç‡∫±‡∫á‡∫Ñ‡∫ª‡∫á‡ªÄ‡∫î‡∫µ‡∫°
        document.addEventListener('keydown', (e) => {
            if (isGameOver || currentLanguage === '' || currentMode === '' || e.repeat) return;
            // ... (Keydown Logic ‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫Å‡ªà‡∫≠‡∫ô‡ªú‡ªâ‡∫≤) ...
            
            let typedChar = e.key;
            
            const targetEnemy = currentEnemy; 
            if (!targetEnemy) {
                incorrectHits++;
                playAudio('error');
                updateStats();
                return;
            }

            if (currentMode === 'char') {
                let enemyChar = targetEnemy.getAttribute('data-word');
                let targetCharForMatch = enemyChar;
                
                if (currentLanguage === 'en') {
                    targetCharForMatch = targetCharForMatch.toUpperCase();
                    typedChar = typedChar.toUpperCase();
                }
                
                if (targetCharForMatch === typedChar) {
                    createBullet(targetEnemy); 
                } else {
                    incorrectHits++;
                    playAudio('error'); 
                    enemyAttack(targetEnemy, false); 
                }
            } else {
                let charToMatch = targetWord[typedPrefix.length]; 
                let typedCharLower = typedChar;
                if (currentLanguage === 'en') {
                    typedCharLower = typedChar.toLowerCase();
                }

                if (charToMatch && charToMatch === typedCharLower) {
                    typedPrefix += charToMatch;
                    renderEnemyText(targetEnemy, targetWord, typedPrefix);
                    
                    if (typedPrefix.length === targetWord.length) {
                        targetEnemy.style.border = '3px solid #00C853';
                        createBullet(targetEnemy); 
                    }
                } else {
                    incorrectHits++;
                    playAudio('error'); 
                    enemyAttack(targetEnemy, false); 
                }
            }
            updateStats();
            
        });
        
        // ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô: ‡∫™‡∫∞‡ªÅ‡∫î‡∫á‡ªú‡ªâ‡∫≤‡∫à‡ªç‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫û‡∫≤‡∫™‡∫≤
        setScreen('start');
    </script>

</body>
</html>
